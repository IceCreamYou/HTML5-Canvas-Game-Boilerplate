/**
 * HTML5 Canvas Game Boilerplate
 * Certain components copyright their respective authors.
 * @author Isaac Sukin
 * @license MIT License
 * @ignore
 */
function Timer(t,e){this.autoStart=t===void 0?!0:t,this.whileAnimating=e||!1,this.lastStartTime=0,this.lastDeltaTime=0,this.elapsedTime=0,this.running=!1,this.getDelta=function(){var t=0;if(this.running){var e=this.whileAnimating?App.physicsTimeElapsed:performance.now();t=(e-this.lastDeltaTime)/1e3,this.lastDeltaTime=e,this.elapsedTime+=t}return t},this.start=function(){this.running||(this.lastStartTime=this.lastDeltaTime=this.whileAnimating?App.physicsTimeElapsed:performance.now(),this.running=!0)},this.stop=function(){this.elapsedTime+=this.getDelta(),this.running=!1},this.getElapsedTime=function(){return this.getDelta(),this.elapsedTime},this.autoStart&&this.start()}function World(t,e){this.scale=1,this.width=t||parseInt($canvas.attr("data-worldwidth"),10)||canvas.width,this.height=e||parseInt($canvas.attr("data-worldheight"),10)||canvas.height,this.xOffset=(this.width-canvas.width)/2,this.yOffset=(this.height-canvas.height)/2,context.translate(-this.xOffset,-this.yOffset),this.getOffsets=function(){return{x:this.xOffset,y:this.yOffset}},this.resize=function(t,e){var i=(t-this.width)/2,s=(e-this.height)/2;this.xOffset+=i,this.yOffset+=s,context.translate(-i,-s),this.width=t,this.height=e,jQuery(document).trigger("resizeWorld",[i,s,this])},this.scaleResolution=function(t,e,i){1!==t&&($canvas.css({width:canvas.width/this.scale+"px",height:canvas.height/this.scale+"px"}),canvas.width=0|canvas.width*t,canvas.height=0|canvas.height*t,e=e||0,i=i||0,this.xOffset=0|Math.min(this.width-canvas.width,Math.max(0,e-canvas.width/2)),this.yOffset=0|Math.min(this.height-canvas.height,Math.max(0,i-canvas.height/2)),context.translate(-this.xOffset,-this.yOffset),this.scale=t,isAnimating()||draw())},this.centerViewportAround=function(t,e){var i=0|Math.min(this.width-canvas.width,Math.max(0,t-canvas.width/2)),s=0|Math.min(this.height-canvas.height,Math.max(0,e-canvas.height/2)),n=this.xOffset-i,a=this.yOffset-s;this.xOffset=i,this.yOffset=s,context.translate(n,a)},this.isInView=function(t,e){return e?t.x+t.width>this.xOffset&&t.x<this.xOffset+canvas.width&&t.y+t.height>this.yOffset&&t.y<this.yOffset+canvas.height:t.x>this.xOffset&&t.x+t.width<this.xOffset+canvas.width&&t.y>this.yOffset&&t.y+t.height<this.yOffset+canvas.height},this.isInWorld=function(t,e){return e?t.x+t.width>=0&&t.x<=world.width&&t.y+t.height>=0&&t.y<=world.height:t.x>=0&&t.x+t.width<=world.width&&t.y>=0&&t.y+t.height<=world.height}}function Layer(t){t=t||{},this.canvas=t.canvas||document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.context.__layer=this,this.width=t.width||(t.canvas?t.canvas.width:0)||world.width||canvas.width,this.height=t.height||(t.canvas?t.canvas.height:0)||world.height||canvas.height,this.x=t.x||0,this.y=t.y||0,this.relative=t.relative||"world",this.opacity=t.opacity||1,this.parallax=t.parallax||1,this.canvas.width!=this.width&&(this.canvas.width=this.width),this.canvas.height!=this.height&&(this.canvas.height=this.height),this.xOffset=0,this.yOffset=0,t.src&&this.context.drawImage(t.src,0,0,this.width,this.height),this.draw=function(t,e,i){return t instanceof CanvasRenderingContext2D||(i=e,e=t,t=context),e=e===void 0?this.x:e,i=i===void 0?this.y:i,t.save(),t.globalAlpha=this.opacity,"canvas"==this.relative&&t.translate(world.xOffset,world.yOffset),(this.xOffset||this.yOffset)&&t.translate(this.xOffset,this.yOffset),t.drawImage(this.canvas,e,i),t.restore(),this},this.clear=function(t){return this.context.clear(t),this},this.scroll=function(t,e,i){return i=i||this.parallax,this.xOffset+=-t*i,this.yOffset+=-e*i,this},this.showCanvasOverlay=function(){stopAnimating();var t=jQuery("<div></div>");t.css({cursor:"pointer",display:"block",height:"100%",left:0,position:"absolute",top:0,width:"100%"});var e=jQuery(this.canvas);return e.css({border:"1px solid black",display:"block",margin:"0 auto",position:"absolute","z-index":100}).click(function(){t.remove(),startAnimating()}),t.append(e),jQuery("body").append(t),t.click(function(e){3!=e.which&&t.remove()}),t}}function Collection(){this.concat.apply(this,arguments)}function ImageWrapper(t,e,i,s,n){this.src=t,this.x=e,this.y=i,this.width=s,this.height=n,this.draw=function(t){(t||context).drawImage(this.src,this.x,this.y,this.width,this.height)}}function TileMap(t,e,i){var s,n,a,o;this.options={cellSize:[Box.prototype.DEFAULT_WIDTH,Box.prototype.DEFAULT_HEIGHT],gridSize:null},i&&i.cellSize instanceof Array&&i.cellSize.length>1&&(this.options.cellSize=i.cellSize),i&&i.gridSize instanceof Array&&i.gridSize.length>1&&(this.options.gridSize=i.gridSize),(e===void 0||null===e)&&(e=[]),(this.options.startCoords===void 0||0===this.options.startCoords.length)&&(this.options.startCoords=[0,world.height-this.options.cellSize[1]*("string"==typeof t?t.split("\n"):t).length]);var r=this.options.gridSize,h=this.options.cellSize[0],l=this.options.cellSize[1],c=this.options.startCoords[0],u=this.options.startCoords[1];if(r instanceof Array&&r.length>0)for(t=Array(r[0]),s=0;r[0]>s;s++)for(t[s]=Array(r[1]),n=0;r[1]>n;n++)t[s][n]=null;if("string"==typeof t)for(t=t.split("\n"),s=0,a=t.length;a>s;s++)t[s]=t[s].split("");for(this.grid=t,e!==void 0&&e[" "]===void 0&&(e[" "]=null),s=0,a=t.length;a>s;s++)for(n=0,o=t[s].length;o>n;n++)if(null!==t[s][n]){var p=e?e[t[s][n]]:t[s][n];if(null===p||void 0===p)this.grid[s][n]=null;else{var d=c+n*h,f=u+s*l;this.grid[s][n]="string"==typeof p||p instanceof Image||p instanceof HTMLImageElement||p instanceof HTMLCanvasElement||p instanceof Sprite||p instanceof SpriteMap||p instanceof Layer?new ImageWrapper(p,d,f,h,l):p instanceof Function?new(Function.prototype.bind.call(p,null,d,f,h,l)):null}}else this.grid[s][n]=null;this.draw=function(t,e,i){t=t||context;var s,n;{if(!e){for(s=0,n=this.grid.length;n>s;s++)for(var a=0,o=this.grid[s].length;o>a;a++){var r=this.grid[s][a];null!==r&&r.draw(t,i)}return this}var h=this.getCellsInRect();for(s=0,n=h.length;n>s;s++)h[s].draw(t,i)}},this.getCell=function(t,e){return this.grid[t]?this.grid[t][e]:void 0},this.setCell=function(t,e,i){return this.grid[t]&&this.grid[t][e]!==void 0&&(this.grid[t][e]=i),this},this.clearCell=function(t,e){return this.grid[t]&&this.grid[t][e]!==void 0&&(this.grid[t][e]=null),this},this.getAll=function(){var t=this.grid.length,e=t>0?this.grid[0].length:0,i=[],s,n;for(s=0;t>s;s++)for(n=0;e>n;n++)null!==this.grid[s][n]&&i.push(this.grid[s][n]);return i},this.clearAll=function(){var e=this.grid.length,i=e>0?this.grid[0].length:0,s,n;for(this.grid=Array(e),s=0;e>s;s++)for(this.grid[s]=Array(i),n=0;i>n;n++)t[s][n]=null;return this},this.getRows=function(){return this.grid.length},this.getCols=function(){return this.grid.length>0?this.grid[0].length:0},this.forEach=function(t,e){var i=this.grid.length,s=i>0?this.grid[0].length:0,n,a;for(n=0;i>n;n++)for(a=0;s>a;a++)(null!==this.grid[n][a]||e)&&t(this.grid[n][a],n,a)&&("function"==typeof this.grid[n][a].destroy&&this.grid[n][a].destroy(),this.clearCell(n,a));return this},this._getCellCoordsInRect=function(t,e,i,s){t===void 0&&(t=world.xOffset),e===void 0&&(e=world.yOffset),i===void 0&&(i=canvas.width),s===void 0&&(s=canvas.height);var n=this.options.startCoords[0],a=this.options.startCoords[1],o=this.options.cellSize[0],r=this.options.cellSize[1],h=(t-n)/o,l=(e-a)/r,c=(t+i-n)/o,u=(a-e+s)/r;return[Math.floor(h),Math.floor(l),Math.ceil(c),Math.ceil(u)]},this.getCellsInRect=function(t,e,i,s){for(var n=this._getCellCoordsInRect(t,e,i,s),a=[],o=Math.min(this.getRows(),Math.max(0,n[1])),r=Math.min(this.getRows(),Math.max(0,n[3])),h=Math.min(this.getCols(),Math.max(0,n[0])),l=Math.min(this.getCols(),Math.max(0,n[2])),c=o,u=r;u>c;c++)for(var p=h,d=l;d>p;p++)null!==this.grid[c][p]&&a.push(this.grid[c][p]);return a}}(function(t){function e(e){if("string"==typeof e.data){var i=e.handler,s=e.data.toLowerCase().split(" ");e.handler=function(e){if(this===e.target||!(/textarea|select/i.test(e.target.nodeName)||t.inArray(e.target.type,t.hotkeys.textTypes)>-1)){var n="keypress"!==e.type&&t.hotkeys.specialKeys[e.which],a=String.fromCharCode(e.which).toLowerCase(),o="",r={};e.altKey&&"alt"!==n&&(o+="alt+"),e.ctrlKey&&"ctrl"!==n&&(o+="ctrl+"),e.metaKey&&!e.ctrlKey&&"meta"!==n&&(o+="meta+"),e.shiftKey&&"shift"!==n&&(o+="shift+"),n?r[o+n]=!0:(r[o+a]=!0,r[o+t.hotkeys.shiftNums[a]]=!0,"shift+"===o&&(r[t.hotkeys.shiftNums[a]]=!0));var h,c;for("keydown"===e.type?(c=n||a,h=t.inArray(c,t.hotkeys.keysDown),(void 0===h||0>h)&&t.hotkeys.keysDown.push(c)):"keyup"===e.type&&(c=n||a,h=t.inArray(c,t.hotkeys.keysDown),void 0!==h&&h>-1&&t.hotkeys.keysDown.splice(h,1),t.hotkeys.lastKeysPressed.push(c),t.hotkeys.lastKeysPressed.length>5&&t.hotkeys.lastKeysPressed.shift()),h=0,l=s.length;l>h;h++)if(r[s[h]])return e.keyPressed=s[h],i.apply(this,arguments)}}}}t.hotkeys={version:"0.9",keysDown:[],lastKeysPressed:[],textTypes:["text","search","tel","url","email","password","number","range","date","month","week","time","datetime","datetime-local","color"],specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|","[":"{","]":"}"},areKeysDown:function(e){var i;if("string"==typeof e){var s=e.split(" ");for(i=0;s.length>i;i++)if(this.areKeysDown(s[i].split("+")))return!0;return!1}var n=!1,a=this.keysDown.length;if(a!=e.length)return!1;for(i=0;a>i;i++)if(t.inArray(this.keysDown[i],["alt","ctrl","meta","shift"])>-1){n=!0;break}if(n){for(i=0;a>i;i++)if(-1==t.inArray(this.keysDown[i],e))return!1}else for(i=0;a>i;i++)if(this.keysDown[i]!=e[i])return!1;return!0},lastKeyPressed:function(){return this.lastKeysPressed[this.lastKeysPressed.length-1]}},t.each(["keydown","keyup","keypress"],function(){t.event.special[this]={add:e}}),t(document).keydown("na",function(){}),t(document).keyup("na",function(){})})(jQuery),function(){var t=!1,e=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(i){function s(){!t&&this.init&&this.init.apply(this,arguments)}var n=this.prototype;t=!0;var a=new this;t=!1;for(var o in i)a[o]="function"==typeof i[o]&&"function"==typeof n[o]&&e.test(i[o])?function(t,e){return function(){var i=this._super;this._super=n[t];var s=e.apply(this,arguments);return this._super=i,s}}(o,i[o]):i[o];return s.prototype=a,s.prototype.constructor=s,s.extend=arguments.callee,s}}(),function(){function t(t,e,i){var s="function"==typeof i.postInitCallback?i.postInitCallback:null,n=this;i.postInitCallback=function(t){n.sprite=t,n.baseImage=t.image,n.cachedImages={"00":n.baseImage},n.maps={};for(var i in e)e.hasOwnProperty(i)&&n.set(i,e[i]);s&&s.apply(this,arguments)},this.sprite=new Sprite(t,i),this.sprite.spriteMap=this}t.prototype={set:function(t,e){e instanceof Array&&(e={startRow:e[0],startCol:e[1],endRow:e[2],endCol:e[3],squeeze:e[4],flipped:e[5]}),this.maps[t]={startRow:e.startRow!==void 0?e.startRow:0,startCol:e.startCol!==void 0?e.startCol:0,endRow:e.endRow!==void 0?e.endRow:this.sprite.rows-1,endCol:e.endCol!==void 0?e.endCol:this.sprite.cols-1,squeeze:e.squeeze!==void 0?e.squeeze:!1,flipped:e.flipped!==void 0?e.flipped:{horizontal:!1,vertical:!1}};var i=this.maps[t].flipped,s=(i.horizontal?"1":"0")+(i.vertical?"1":"0");return this.sprite.cachedImages[s]===void 0&&(this.sprite.cachedImages[s]=this.sprite._prerender(this.baseImage,i)),this},unset:function(t){return this.maps.hasOwnProperty(t)&&delete this.maps[t],this},use:function(t,e){if(this.activeLoop==t&&!e)return this;this.activeLoop=t;var i=this.maps[t];return this.sprite.setLoop(i.startRow,i.startCol,i.endRow,i.endCol,i.squeeze,i.flipped),this},start:function(t){return t&&this.use(t),this.sprite.startLoop(),this},stop:function(){return this.sprite.stop(),this},reset:function(){return this.sprite.reset(),this},runOnce:function(t,e){return e&&this.use(e),this.sprite.runLoop(t),this},draw:function(t,e,i,s,n){return this.sprite.draw(t,e,i,s,n),this},clone:function(){return new t(this.sprite.sourceFile,this.maps,this.sprite)}},this.SpriteMap=t}.call(this),function(){function t(e,i){if("string"==typeof e){this.sourceFile=e;var s=t.getImageFromCache(e);if(s)this._init(s,i);else{var n=new Image,a=this;n.onload=function(){a._init(this,i)},n._src=e,n.src=e,t.saveImageToCache(e,n)}}else if(e instanceof HTMLImageElement||e instanceof Image){if(!e.src)return;if(this.sourceFile=e._src||e.src,e.complete||e.width&&e.height)t.saveImageToCache(this.sourceFile,e),this._init(e,i);else{if(e._src)return;var o=e.onload,a=this;e.onload=function(){"function"==typeof o&&o(),t.saveImageToCache(a.sourceFile,e),a._init(this,i)}}}else e instanceof HTMLCanvasElement&&this._init(e,i)}t.prototype={_init:function(t,e){this.width=t.width,this.height=t.height,this.frameW=e.frameW||t.width,this.frameH=e.frameH||t.height,this.projectedW=e.projectedW||this.frameW,this.projectedH=e.projectedH||this.frameH,this.rows=Math.floor(this.height/this.frameH),this.cols=Math.floor(this.width/this.frameW),this.startRow=e.startRow||0,this.startCol=e.startCol||0,this.endRow=e.endRow===void 0?this.rows-1:e.endRow,this.endCol=e.endCol===void 0?this.cols-1:e.endCol,this.row=this.startRow,this.col=this.startCol,this.frame=1,this.squeeze=e.squeeze||!1,this.interval=e.interval===void 0?125:e.interval,this.useTimer=e.useTimer===void 0?!0:e.useTimer,this.advanceFramesManually=e.advanceFramesManually||!1,this.lastFrameUpdateTime=0,this.flipped=e.flipped||{horizontal:!1,vertical:!1},this.flipped.horizontal=this.flipped.horizontal||!1,this.flipped.vertical=this.flipped.vertical||!1,this.cachedImages={"00":t};var i=this.flipped,s=(i.horizontal?"1":"0")+(i.vertical?"1":"0");this.cachedImages[s]===void 0&&(this.cachedImages[s]=this._prerender(t,i)),this.image=this.cachedImages[s],this._runOnce=!1,this.squeeze&&(this.cols=this.endCol-this.startCol+1),this.numFrames=this.getNumFrames(),e.postInitCallback&&e.postInitCallback(this)},_prerender:function(t,e){var i=document.createElement("canvas");i.width=this.width,i.height=this.height;var s=i.getContext("2d");return(e.horizontal||e.vertical)&&(s.translate(e.horizontal?i.width:0,e.vertical?i.height:0),s.scale(e.horizontal?-1:1,e.vertical?-1:1)),s.drawImage(t,0,0),i},draw:function(t,e,i,s,n){try{t.save(),s=s||this.projectedW,n=n||this.projectedH;var a=this.col*this.frameW,o=this.row*this.frameH;this.flipped.horizontal&&(a=this.width-a-this.frameW),this.flipped.vertical&&(o=this.height-o-this.frameH),t.drawImage(this.image,a,o,this.frameW,this.frameH,e,i,s,n),t.restore()}catch(r){console&&console.error&&console.error(r)}return!this.useTimer&&!this.advanceFramesManually&&Date.now()-this.lastFrameUpdateTime>this.interval&&this.nextFrame(),this},reset:function(){return this.row=this.startRow,this.col=this.startCol,this.frame=1,this.lastFrameUpdateTime=0,this},changeFrame:function(t){return this.frame+=t,this.setFrame(this.frame),this},setFrame:function(t,e){if(e!==void 0)this.row=t,this.col=e,this.frame=this.squeeze?this.cols*(this.row-this.startRow+1)-(this.endCol-this.col):this.cols*(this.row-this.startRow+1)-(this.cols-(this.col+1))-this.startCol;else{var i=this.frameNumberToRowCol(t);this.frame=i.frame,this.row=i.row,this.col=i.col}return this.lastFrameUpdateTime=Date.now(),this},setLoop:function(t,e,i,s,n,a){if(this.stopLoop(),(null===i||i===void 0)&&(i=this.rows-1),(null===s||s===void 0)&&(s=this.cols-1),n!==void 0&&(this.squeeze=n),a!==void 0){this.flipped=a;var o=this.flipped,r=(o.horizontal?"1":"0")+(o.vertical?"1":"0");this.cachedImages[r]===void 0&&(this.cachedImages[r]=this._prerender(this.image,o)),this.image=this.cachedImages[r]}return this.startRow=t,this.startCol=e,this.endRow=i,this.endCol=s,this.reset(),this.numFrames=this.getNumFrames(),this},startLoop:function(t,e,i,s,n,a){if(t!==void 0&&e!==void 0&&this.setLoop(t,e,i,s,n,a),this.lastFrameUpdateTime=Date.now(),this.interval&&this.useTimer){var o=this;this.intervalID=setInterval(function(){o.nextFrame()},this.interval)}return this},stopLoop:function(){return this.lastFrameUpdateTime=0,this.intervalID&&clearInterval(this.intervalID),this},runLoop:function(t,e,i,s,n,a,o){return this.runLoopCallback=t||function(){},this._runOnce=!0,Array.prototype.shift.call(arguments),this.startLoop.apply(this,arguments),this},prevFrame:function(){return changeFrame(-1),this},nextFrame:function(){return this.col++,this.frame++,this.row==this.endRow&&this.col>this.endCol?this._runOnce?(this.stopLoop(),this._runOnce=!1,this.runLoopCallback(this)):this.reset():this.squeeze&&this.col>this.endCol?(this.col=this.startCol,this.row++):!this.squeeze&&this.col>=this.cols&&(this.col=0,this.row++),this.lastFrameUpdateTime=Date.now(),this},getFrame:function(){return{row:this.row,col:this.col,frame:this.frame}},getNumFrames:function(){return this.squeeze?(this.endRow-this.startRow+1)*(this.endCol-this.startCol+1):(this.endRow-this.startRow)*this.cols-this.startCol+this.endCol+1},frameNumberToRowCol:function(t){var e,i;return t=(t+this.numFrames)%this.numFrames||this.numFrames,this.squeeze?(e=this.startRow+Math.floor((t-1)/this.cols),i=(t-1)%this.cols+this.startCol):(e=this.startRow+Math.floor((t+this.startCol-1)/this.cols),i=(t+this.startCol-1)%this.cols),{frame:t,row:e,col:i}},clone:function(){return new t(this.sourceFile,this)}},this.Sprite=t}.call(this),function(){var t={};Sprite.getImageFromCache=function(e){return t[e]?t[e]:null},Sprite.saveImageToCache=function(e,i){t[e]=i},Sprite.preloadImages=function(t,e){var i=t.length,s=-1,n,a,o=function(t,n){s++,"function"==typeof t&&t(n,s,i),s==i&&"function"==typeof e.finishCallback&&e.finishCallback(i)};o();for(var r=function(){Sprite.saveImageToCache(this._src,this),o(e.itemCallback,this._src)};t.length;)n=t.pop(),a=new Image,a._num=i-t.length,a._src=n,a.onload=r,a.src=n}}.call(this);var App={};App.isGameOver=!1,App.debugMode=!1,App.MIN_FPS=4,App.MAX_FPS=100,App.physicsTimeElapsed=0,App.physicsDelta=0,App.Debug={},App.Debug.updateTimeElapsed=0,App.Debug.clearTimeElapsed=0,App.Debug.drawTimeElapsed=0;var canvas,$canvas,context,world;App.setCanvas=function(t){if("string"==typeof t){var e=t;t=document.getElementById(t),t instanceof HTMLCanvasElement||!window.console||!console.warn||console.warn("No canvas with ID "+e+" found.")}if(t instanceof HTMLCanvasElement)world!==void 0&&(context.translate(world.xOffset,world.yOffset),world.scaleResolution(1/world.scale)),canvas=t,$canvas=jQuery(canvas),App.beforeSetup();else{if(canvas instanceof HTMLCanvasElement&&$canvas!==void 0)return;if(canvas=document.getElementById("canvas"),!(canvas instanceof HTMLCanvasElement))for(var i=0,s=document.getElementsByTagName("canvas"),n=s.length;n>i;i++)if("false"!=s[i].getAttribute("data-takeover")){canvas=s[i];break}canvas instanceof HTMLCanvasElement||(canvas=document.createElement("canvas")),$canvas=jQuery(canvas),App.isSetup?App.beforeSetup():jQuery(window).load(App.beforeSetup)}},jQuery(document).ready(App.setCanvas),App.beforeSetup=function(){if(App.isSetup=!0,"undefined"!=typeof keys)for(var t in keys)keys.hasOwnProperty(t)&&App.preventDefaultKeyEvents(keys[t].join(" "));App.setDefaultCanvasSize(),context=canvas.getContext("2d"),"undefined"!=typeof Stats&&App.debugMode&&(App.stats=new Stats,App.stats.setMode(0),App.stats.domElement.style.position="absolute",App.stats.domElement.style.left=$canvas.offset().left,App.stats.domElement.style.top=$canvas.offset().top,document.body.appendChild(App.stats.domElement)),Caches.preloadImages("undefined"==typeof preloadables?[]:preloadables,{finishCallback:function(){"undefined"==typeof Events&&App.Events!==void 0&&(Events=App.Events),"undefined"==typeof Utils&&App.Utils!==void 0&&(Utils=App.Utils),App.reset(!0)}})},App.reset=function(t){stopAnimating(),App.isSomethingBeingDragged&&(App.isSomethingBeingDragged=!1,jQuery(document).trigger("canvasdragstop")),world!==void 0&&(context.translate(world.xOffset,world.yOffset),world.scaleResolution(1/world.scale)),world=new World,context.__layer=world,App.timer=new Timer(!1),App.timer.frames=0,App.isGameOver=!1,App.physicsTimeElapsed=0,App.Debug.updateTimeElapsed=0,App.Debug.clearTimeElapsed=0,App.Debug.drawTimeElapsed=0;var e=setup(!!t);Timer.event("app start"),e!==!1&&startAnimating(),jQuery(document).trigger("start",[!!t])},App.setDefaultCanvasSize=function(){if("false"!=$canvas.attr("data-resize")){var t=jQuery(window);if("full"==$canvas.attr("data-resize"))canvas.width=t.innerWidth()-parseInt($canvas.css("border-left-width"),10)-parseInt($canvas.css("border-right-width"),10)-1,canvas.height=t.innerHeight()-parseInt($canvas.css("border-top-width"),10)-parseInt($canvas.css("border-bottom-width"),10)-1;else{var e=$canvas.attr("data-maxwidth")||canvas.width,i=$canvas.attr("data-minwidth")||canvas.width;canvas.width=Math.min(e,Math.max(t.width(),i));var s=$canvas.attr("data-maxheight")||canvas.height,n=$canvas.attr("data-minheight")||canvas.height;canvas.height=Math.min(s,Math.max(t.height(),n))}var a=$canvas.attr("data-aspectratio")||0;a&&(-1==a.indexOf(":")?a=parseFloat(a):"4:3"==a?a=4/3:"16:9"==a?a=16/9:("16:10"==a||"8:5"==a)&&(a=1.6),canvas.width<canvas.height*a?canvas.height=Math.floor(canvas.width/a):canvas.width>canvas.height*a&&(canvas.width=Math.floor(canvas.height*a)))}};var Caches={images:{},imagePatterns:{},preloadImages:function(t,e){var i=t.length,s=-1,n,a,o=function(t,n){s++,"function"==typeof t&&t(n,s,i),s==i&&"function"==typeof e.finishCallback&&e.finishCallback(i)};o();for(var r=function(){Caches.images[this._src]=this,o(e.itemCallback,this._src)};t.length;)n=t.pop(),a=new Image,a._num=i-t.length,a._src=n,a.onload=r,a.src=n}};"undefined"!=typeof Sprite&&(Sprite.getImageFromCache=function(t){return Caches.images[t]},Sprite.saveImageToCache=function(t,e){Caches.images[t]=e},Sprite.preloadImages=Caches.preloadImages),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),function(){function t(){App.stats!==void 0&&App.stats.begin();var i=App.timer.getDelta();for(App.timer.running||App.timer.start(),App.MIN_FPS&&i>1/App.MIN_FPS&&(jQuery(document).trigger("low_fps",[1/i]),i=1/App.MIN_FPS),App.timer.frames++,App.debugMode&&Timer.event("debug timer update",!0),window.Mouse&&Mouse.Scroll&&Mouse.Scroll._update();i>0&&!App.isGameOver;)App.physicsDelta=Math.min(i,1/App.MAX_FPS),"function"==typeof update&&update(App.physicsDelta,App.physicsTimeElapsed),i-=App.physicsDelta,App.physicsTimeElapsed+=App.physicsDelta;App.debugMode&&(App.Debug.updateTimeElapsed+=Timer.getTimeSince("debug timer update"),Timer.event("debug timer clear",!0)),context.clear(),App.debugMode&&(App.Debug.clearTimeElapsed+=Timer.getTimeSince("debug timer clear"),Timer.event("debug timer draw",!0)),draw(),App.debugMode&&(App.Debug.drawTimeElapsed+=Timer.getTimeSince("debug timer draw")),App.stats!==void 0&&App.stats.end(),e&&window.requestAnimFrame(t)}var e=!1,i=!1;window.startAnimating=function(){e||void 0===App.timer||(e=!0,jQuery(document).trigger("startAnimating"),t())},window.stopAnimating=function(){if(e&&void 0!==App.timer&&(e=!1,App.timer.stop(),jQuery(document).trigger("stopAnimating"),App.debugMode&&console&&console.log)){var t=App.physicsTimeElapsed,i=App.timer.frames,s=App.Debug,n=s.updateTimeElapsed+s.clearTimeElapsed+s.drawTimeElapsed;console.log({"ms/frame":{update:s.updateTimeElapsed/i,clear:s.clearTimeElapsed/i,draw:s.drawTimeElapsed/i,animOps:n/i,other:(t-n)/i,animate:t/i},percent:{update:100*(s.updateTimeElapsed/t),clear:100*(s.clearTimeElapsed/t),draw:100*(s.drawTimeElapsed/t),animOps:100*(n/t),other:100*((t-n)/t)},fps:i/t})}},window.isAnimating=function(){return e},jQuery(window).on("focus.animFocus",function(){i&&(i=!1,startAnimating())}),jQuery(window).on("blur.animFocus",function(){stopAnimating(),i=!0})}(),App.preventDefaultKeyEvents=function(t){jQuery.hotkeys?jQuery(document).keydown(t,function(){return!1}):window.console&&console.warn&&console.warn("Tried to prevent default key events but jQuery.hotkeys does not exist.")},window.performance=window.performance||{},performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return Date.now()}}(),function(){var t={},e=0;Timer.event=function(i,s){var n={whileAnimating:s,startTime:s?App.physicsTimeElapsed:performance.now()};i===void 0?e=n:t[i]=n},Timer.getTimeSince=function(i){var s=t[i]===void 0?e:t[i],n=s.whileAnimating?App.physicsTimeElapsed:performance.now();return s.startTime?(n-s.startTime)/1e3:0}}(),App.Utils={},App.Utils.percentToPixels=function(t,e){return e===void 0&&(e=!0),{x:Math.floor((e?canvas:world).width*t/100),y:Math.floor((e?canvas:world).height*t/100)}},App.Utils.getRandBetween=function(t,e){if(t>e){var i=t;t=e,e=i}return Math.random()*(e-t)+t},App.Utils.getRandIntBetween=function(t,e){if(t>e){var i=t;t=e,e=i}return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1)+t)},App.Utils.anyIn=function(t,e){for(var i=0,s=t.length;s>i;i++)if(-1!=e.indexOf(t[i]))return!0;return!1},App.Utils.almostEqual=function(t,e,i){return t>=e-i&&e+i>=t},App.Utils.randomString=function(t){var e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_",i="";t=t||32;for(var s=0;t>s;s++)i+=e.charAt(Math.floor(Math.random()*e.length));return i},App.Utils.positionOverCanvas=function(t,e,i){var s=$canvas.offset();jQuery(t).css({left:s.left+parseInt($canvas.css("border-left-width"),10)+e+"px",position:"absolute",top:s.top+parseInt($canvas.css("border-top-width"),10)+i+"px","z-index":100})},App.gameOver=function(t){App.isGameOver||(App.isGameOver=!0,stopAnimating(),player&&player.destroy(),"string"!=typeof t&&(t="GAME OVER"),setTimeout(function(){context.save(),context.font="100px Arial",context.fillStyle="black",context.strokeStyle="lightGray",context.textBaseline="middle",context.textAlign="center",context.shadowColor="black",context.shadowBlur=8,context.lineWidth=5;var e=Math.round(world.xOffset+canvas.width/2),i=Math.round(world.yOffset+canvas.height/2);context.strokeText(t,e,i),context.fillText(t,e,i),context.restore()},100),$canvas.css("cursor","pointer"),$canvas.one("click.gameover",function(t){t.preventDefault(),$canvas.css("cursor","auto"),App.reset()}))},Array.prototype.remove=function(t){var e=this.indexOf(t);return void 0===e||0>e?void 0:this.splice(e,1)},Number.prototype.round=function(t,e){e===void 0&&(e=t,t=this),e||(e=0);var i=Math.pow(10,0|e);return Math.round(t*i)/i},Number.prototype.sign=function(t){return t===void 0&&(t=this),t>0?1:0>t?-1:0},CanvasRenderingContext2D.prototype.clear=function(t){this.save();var e=0,i=0;this.__layer?(e=this.__layer.xOffset,i=this.__layer.yOffset):this.setTransform(1,0,0,1,0,0),t?(this.fillStyle=t,this.fillRect(e,i,this.canvas.width,this.canvas.height)):this.clearRect(e,i,this.canvas.width,this.canvas.height),this.restore()},CanvasRenderingContext2D.prototype.__drawImage=CanvasRenderingContext2D.prototype.drawImage,CanvasRenderingContext2D.prototype.drawImage=function(t,e,i,s,n,a,o,r,h,l){0===arguments.length%2&&(l=Array.prototype.pop.call(arguments),s instanceof Function?s=void 0:a instanceof Function?a=void 0:r instanceof Function&&(r=void 0),"function"!=typeof l&&(l=void 0));var c=this,u=arguments;"number"!=typeof a&&o===void 0&&"number"!=typeof r&&h===void 0&&(a=e,o=i,"number"==typeof s&&n!==void 0&&(r=s,h=n),e=void 0,i=void 0,s=void 0,n=void 0);var p=function(t,e,i,s,n,a,o,r,h){s&&n?r&&h?c.__drawImage(t,a,o,r,h,e,i,s,n):c.__drawImage(t,e,i,s,n):c.__drawImage(t,e,i),l instanceof Function&&l.call(c,u,!0)};if("undefined"!=typeof Sprite&&t instanceof Sprite||"undefined"!=typeof SpriteMap&&t instanceof SpriteMap)t.draw(this,a,o,r,h),l instanceof Function&&l.call(c,u,!0);else if(Layer!==void 0&&t instanceof Layer){c.save(),c.globalAlpha=t.opacity,"canvas"==t.relative&&c.translate(world.xOffset,world.yOffset);var d=l;l=void 0,p(t.canvas,a,o,r,h,e,i,s,n),c.restore(),l=d,l instanceof Function&&l.call(c,u,!0)}else if(t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement)p(t,a,o,r,h,e,i,s,n);else if(t instanceof HTMLImageElement||t instanceof Image){var f=t;if(t=f._src||f.src,!t)return l instanceof Function&&l.call(c,u,!1),void 0;if(Caches.images[t]||(Caches.images[t]=f),f.complete||f.width&&f.height)p(f,a,o,r,h,e,i,s,n);else{if(f._src)return;var g=f.onload;f.onload=function(){"function"==typeof g&&g(),l instanceof Function&&l.call(c,u,!1)}}}else if("string"==typeof t&&Caches.images[t]){var f=Caches.images[t];(f.complete||f.width&&f.height)&&p(f,a,o,r,h,e,i,s,n)}else{if("string"!=typeof t)throw new TypeMismatchError("Image type not recognized.");var f=new Image;f.onload=function(){l instanceof Function&&l.call(c,u,!1)},f._src=t,f.src=t,Caches.images[t]=f}},CanvasRenderingContext2D.prototype.drawPattern=function(t,e,i,s,n,a,o){if(e===void 0&&(e=0),i===void 0&&(i=0),s===void 0&&(s=this.canvas.width),n===void 0&&(n=this.canvas.height),"function"==typeof a?(o=a,a="repeat"):a||(a="repeat"),Layer!==void 0&&t instanceof Layer&&(t=t.canvas),t instanceof CanvasPattern)this.fillStyle=t,this.fillRect(e,i,s,n),o instanceof Function&&o.call(this,arguments,!0);else if(Layer!==void 0&&t instanceof Layer)this.save(),this.globalAlpha=t.opacity,"canvas"==t.relative&&this.translate(world.xOffset,world.yOffset),this.fillStyle=this.createPattern(t.canvas,a),this.fillRect(e,i,s,n),this.restore(),o instanceof Function&&o.call(this,arguments,!0);else if(t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement)this.fillStyle=this.createPattern(t,a),this.fillRect(e,i,s,n),o instanceof Function&&o.call(this,arguments,!0);else if(t instanceof HTMLImageElement||t instanceof Image){var r=t;if(t=r._src||r.src,!t)return o instanceof Function&&o.call(this,arguments,!1),void 0;if(Caches.imagePatterns[t])return this.fillStyle=Caches.imagePatterns[t],this.fillRect(e,i,s,n),o instanceof Function&&o.call(this,arguments,!0),this.fillStyle;if(Caches.images[t]||(Caches.images[t]=r),r.complete||r.width&&r.height)this.fillStyle=this.createPattern(r,a),this.fillRect(e,i,s,n),Caches.imagePatterns[t]=this.fillStyle,o instanceof Function&&o.call(this,arguments,!0);else{if(r._src)return;var h=this,l=r.onload;r.onload=function(){"function"==typeof l&&l(),Caches.imagePatterns[t]=this.createPattern(r,a),o instanceof Function&&o.call(h,arguments,!1)}}}else if("string"==typeof t)if(Caches.imagePatterns[t])this.fillStyle=Caches.imagePatterns[t],this.fillRect(e,i,s,n),o instanceof Function&&o.call(this,arguments,!0);else if(Caches.images[t]){var r=Caches.images[t];(r.complete||r.width&&r.height)&&(this.fillStyle=this.createPattern(r,a),this.fillRect(e,i,s,n),Caches.imagePatterns[t]=this.fillStyle,o instanceof Function&&o.call(this,arguments,!0))}else{var r=new Image,h=this;r.onload=function(){Caches.imagePatterns[t]=this.createPattern(r,a),o instanceof Function&&o.call(h,arguments,!1)},r._src=t,r.src=t,Caches.images[t]=r}return Caches.imagePatterns[t]?Caches.imagePatterns[t]:void 0},CanvasRenderingContext2D.prototype.drawCheckered=function(t,e,i,s,n,a,o){if(t===void 0&&(t=80),"string"==typeof t&&"string"==typeof e){var r=t,h=e;t=i,e=s,i=n,s=a,n=o,a=r,o=h}var l=document.createElement("canvas"),c=l.getContext("2d");return l.width=2*t,l.height=2*t,c.fillStyle=a||"silver",c.fillRect(0,0,t,t),c.fillRect(t,t,t,t),c.fillStyle=o||"lightGray",c.fillRect(t,0,t,t),c.fillRect(0,t,t,t),this.drawPattern(l,e||0,i||0,s||this.canvas.width,n||this.canvas.height)},CanvasRenderingContext2D.prototype.circle=function(t,e,i,s,n){this.beginPath(),this.arc(t,e,i,0,2*Math.PI,!1),null!==s&&(s&&(this.fillStyle=s),this.fill()),void 0!==n&&(this.lineWidth=Math.max(Math.ceil(i/15),1),n&&(this.strokeStyle=n),this.stroke())
},App.isSomethingBeingDragged=!1;var Mouse={coords:{x:9999,y:9999}};jQuery(document).ready(function(){var t=function(t){try{var e=t.pageX||t.originalEvent.touches[0].pageX,i=t.pageY||t.originalEvent.touches[0].pageY;"touchmove"==t.type&&t.preventDefault(),Mouse.coords={x:e-$canvas.offset().left,y:i-$canvas.offset().top}}catch(s){window.console&&console.error&&console.error("Unable to track cursor location. You are probably using an unusual touch-capable device.")}};$canvas.on("touchmove.coords",t),$canvas.hover(function(){jQuery(this).on("mousemove.coords",t)},function(){jQuery(this).off("mousemove.coords"),Mouse.coords={x:-9999,y:-9999}}),$canvas.on("mousedown mouseup click touchstart touchend",function(e){"touchstart"==e.type&&t(e),isAnimating()&&App.Events!==void 0&&App.Events.trigger(e.type,e)}),$canvas.on("mouseup.drag touchend.drag",function(t){App.Events!==void 0&&App.Events.trigger("canvasdragstop",t),App.isSomethingBeingDragged=!1,jQuery(document).trigger("canvasdragstop")}),jQuery(document).on("canvasdrop",function(t,e){App.Events!==void 0&&App.Events.trigger("canvasdrop",t,e)})}),App.isHovered=function(t){var e=world.getOffsets(),i=t.x-e.x,s=t.y-e.y;return Mouse.coords.x>i&&Mouse.coords.x<i+t.width&&Mouse.coords.y>s&&Mouse.coords.y<s+t.height},Mouse.Scroll=function(){function t(t){var a=!1,o;return void 0===t&&(t=!0),Mouse.coords.x<canvas.width*e?(t&&(o=Math.round(Math.min(world.xOffset,i*App.physicsDelta)),world.xOffset-=o,n.x-=o,context.translate(o,0)),a=!0):Mouse.coords.x>canvas.width*(1-e)&&(t&&(o=Math.round(Math.min(world.width-canvas.width-world.xOffset,i*App.physicsDelta)),world.xOffset+=o,n.x+=o,context.translate(-o,0)),a=!0),Mouse.coords.y<canvas.height*e?(t&&(o=Math.round(Math.min(world.yOffset,i*App.physicsDelta)),world.yOffset-=o,n.y-=o,context.translate(0,o)),a=!0):Mouse.coords.y>canvas.height*(1-e)&&(t&&(o=Math.round(Math.min(world.height-canvas.height-world.yOffset,i*App.physicsDelta)),world.yOffset+=o,n.y+=o,context.translate(0,-o)),a=!0),t&&0===n.x&&0===n.y&&(a=!1),t&&s!=a&&(s?jQuery(document).trigger("mousescrollon"):jQuery(document).trigger("mousescrolloff")),s=a,n}var e=.2,i=350,s=!1,n={x:0,y:0},a=!1;return{enable:function(){a||(a=!0,$canvas.on("mouseenter.translate touchstart.translate",function(){jQuery(this).on("mousemove.translate",function(){t(!1)})}),$canvas.on("mouseleave.translate touchleave.translate",function(){s=!1,jQuery(this).off(".translate")}))},disable:function(){$canvas.off(".translate"),s=!1,a=!1},isEnabled:function(){return a},isScrolling:function(){return s},_update:function(){return s?t():void 0},setThreshold:function(t){e=t},getThreshold:function(){return e},setScrollDistance:function(t){i=t},getScrollDistance:function(){return i}}}(),function(){function t(){return"function"!=typeof App.isHovered?(window.console&&console.warn&&console.warn("Mouse event triggered, but App.isHovered does not exist."),!1):App.isHovered(this)}var e={};App.Events={listen:function(t,i,s,n){var a=arguments[4],o=i.split(" ");if(!(o.length>1)){var r="",h=i.indexOf(".");return-1!==h&&(r=i.substring(h+1),i=i.substring(0,h)),e[i]||(e[i]=[]),e[i].push({object:t,callback:function(){s.apply(t,arguments)},namespace:r,weight:n||0,once:a||!1}),t}for(var l=0,c=o.length;c>l;l++)App.Events.listen(t,o[l],s,n,a)},once:function(t,e,i,s){return App.Events.listen(t,e,i,s,!0)},unlisten:function(t,i){var s=i.split(" ");{if(!(s.length>1)){var n="",a=i.indexOf("."),o;if(-1!==a&&(n=i.substring(a+1),i=i.substring(0,a)),i&&e[i])for(o=e[i],a=o.length-1;a>=0;a--)o[a].object!=t||n&&o[a].namespace!=n||e[i].splice(a,1);else if(!i&&n)for(i in e)if(e.hasOwnProperty(i))for(o=e[i],a=o.length-1;a>=0;a--)o[a].object==t&&o[a].namespace==n&&e[i].splice(a,1);return t}for(var r=0,h=s.length;h>r;r++)App.Events.unlisten(t,s[r])}},trigger:function(t){t=Array.prototype.shift.call(arguments);var i=e[t];if(i){i.sort(function(t,e){return e.weight-t.weight});for(var s=i.length-1;s>=0;s--)if(!App.Events.Behaviors[t]||App.Events.Behaviors[t].apply(i[s].object,arguments)){i[s].callback.apply(i[s].object,arguments),i[s].once&&App.Events.unlisten(i[s].object,t+"."+i[s].namespace);var n=Array.prototype.shift.call(arguments);if(n&&n.isPropagationStopped&&n.isPropagationStopped())break}}},Behaviors:{mousedown:t,mouseup:t,click:t,touchstart:t,touchend:t,canvasdragstop:function(){return!!this.isBeingDragged},canvasdrop:function(t,e){return this===e}}}}.call(this),App.Storage=function(t,e){var i={enabled:!0},s="__appstore__",n=t.localStorage,a={},o=!1;i.set=function(t,a){return t=s+t,a===e?i.remove(t):(n.setItem(t,JSON.stringify(a)),e)},i.get=function(t,e){t=s+t;try{var i=n.getItem(t);if("string"==typeof i)return JSON.parse(i);if(null!==i)return i}catch(a){console&&console.error&&console.error(a)}return e},i.remove=function(t){n.removeItem(s+t)},i.clear=function(){n.clear()},i.length=function(){return o?a.length:n.length},i.key=function(t){return n.key(t)},i.isEnabled=function(){return i.enabled};try{i.set(s,s),i.get(s)!=s&&(i.enabled=!1),i.remove(s)}catch(r){i.enabled=!1}return i.enabled||(n={setItem:function(t,e){a[t]=e},getItem:function(t){return a[t]},removeItem:function(t){delete a[t]},clear:function(){a={}},key:function(t){var e=0;for(var i in a)if(a.hasOwnProperty(i)){if(e==t)return a[i];e++}}}),i}(window),Collection.prototype={length:0,draw:function(t){t=t||context;for(var e=0;this.length>e;e++)this[e].draw(t);return this},forEach:function(t){if("string"==typeof t)return this._executeMethod.apply(this,arguments);for(var e=this.length-1;e>=0;e--)t(this[e])&&("function"==typeof this[e].destroy&&this[e].destroy(),this.splice(e,1));return this},_executeMethod:function(t){Array.prototype.shift.call(arguments);for(var e=0;this.length>e;e++)this[e][t].apply(this[e],arguments);return this},collideAll:function(t){for(var e=!1,i=0,s=this.length;s>i;i++)for(var n=i+1;s>n;n++)if(this[i].overlaps(this[n])){if("function"!=typeof t)return!0;t.call(this,this[i],this[n]),e=!0}return e},splice:function(){return Array.prototype.splice.apply(this,arguments)},add:function(){return Array.prototype.push.apply(this,arguments)},concat:function(){for(var t=0,e=arguments.length;e>t;t++)if(arguments[t]instanceof Array||arguments[t]instanceof Collection)for(var i=0,s=arguments[t].length;s>i;i++)Array.prototype.push.call(this,arguments[t][i]);else Array.prototype.push.call(this,arguments[t]);return this},remove:function(t){return Array.prototype.remove.call(this,t)},removeLast:function(){return Array.prototype.pop.call(this)},removeFirst:function(){return Array.prototype.shift.call(this)},removeAll:function(){return Array.prototype.splice.call(this,0,this.length),this}};var Box=Class.extend({init:function(t,e,i,s,n){this.x=t!==void 0?t:Math.floor((world.width-this.DEFAULT_WIDTH)/2),this.y=e!==void 0?e:Math.floor((world.height-this.DEFAULT_HEIGHT)/2),this.width=i||this.DEFAULT_WIDTH,this.height=s||this.DEFAULT_HEIGHT,this.fillStyle=n||"black",this.draw()},DEFAULT_WIDTH:80,DEFAULT_HEIGHT:80,src:null,radians:0,draw:function(t,e){t=t||context,e===void 0&&(e=!0),t.save(),t.fillStyle=this.fillStyle;var i=this.x,s=this.y,n=this.width,a=this.height;e&&(i=Math.round(i),s=Math.round(s)),this.radians&&(t.translate(i+n/2,s+a/2),t.rotate(this.radians),t.translate(-n/2-i,-a/2-s)),this.src?t.drawImage(this.src,i,s,n,a):this.drawDefault(t,i,s,n,a),t.restore()},drawDefault:function(t,e,i,s,n){t.fillRect(e,i,s,n)},drawBoundingBox:function(t,e){t=t||context,e&&(t.strokeStyle=e),t.strokeRect(this.x,this.y,this.width,this.height)},xC:function(){return this.x+this.width/2},yC:function(){return this.y+this.height/2},collides:function(t,e,i){if(t instanceof Box&&(t!==this||!i))return this.overlaps(t)?t:!1;var s=t,n=[];(Collection!==void 0&&t instanceof Collection||TileMap!==void 0&&t instanceof TileMap)&&(s=t.getAll());for(var a=0,o=s.length;o>a;a++)if(this.overlaps(s[a])&&(s[a]!==this||!i)){if(!e)return s[a];n.push(s[a])}return n.length?n:!1},overlaps:function(t){return this.overlapsX(t)&&this.overlapsY(t)},overlapsX:function(t){return this.x+this.width>t.x&&t.x+t.width>this.x},overlapsY:function(t){return this.y+this.height>t.y&&t.y+t.height>this.y},isHovered:function(){return"function"!=typeof App.isHovered?(window.console&&console.warn&&console.warn("Box#isHovered called, but App.isHovered does not exist."),!1):App.isHovered(this)},listen:function(t,e,i){return App.Events?App.Events.listen(this,t,e,i):window.console&&console.warn&&console.warn("Box#listen called, but App.Events does not exist."),this},once:function(t,e,i){return App.Events?App.Events.once(this,t,e,i):window.console&&console.warn&&console.warn("Box#once called, but App.Events does not exist."),this},unlisten:function(t){return App.Events?App.Events.unlisten(this,t):window.console&&console.warn&&console.warn("Box#unlisten called, but App.Events does not exist."),this},destroy:function(){},stoodOn:null}),Actor=Box.extend({MOVEAMOUNT:400,GRAVITY:!1,G_CONST:21,JUMP_VEL:500,JUMP_DELAY:.25,AIR_CONTROL:.25,JUMP_RELEASE:!1,MULTI_JUMP:0,CONTINUOUS_MOVEMENT:!1,STAY_IN_WORLD:!0,DAMPING_FACTOR:null,lastLooked:[],isBeingDragged:!1,dropTargets:[],xVelocity:0,yVelocity:0,xAcceleration:0,yAcceleration:0,keys:void 0,lastJump:0,lastDirection:[],jumpDirection:{right:!1,left:!1},jumpKeyDown:!1,numJumps:0,inAir:!1,fallLeft:null,isDraggable:!1,dragStartX:0,dragStartY:0,animLoop:"",init:function(){this._super.apply(this,arguments),this.lastX=this.x,this.lastY=this.y,this.lastDirection=[],this.lastLooked=[],this.jumpDirection={right:!1,left:!1},this.dropTargets=[]},draw:function(){return this.src instanceof SpriteMap&&this.animLoop&&this.src.use(this.animLoop),this._super.apply(this,arguments)},drawDefault:function(t,e,i,s,n){e+=s/2,i+=n/2,r=(s+n)/4,t.circle(e,i,r,"lightBlue","black"),t.beginPath(),t.arc(e,i,.6*r,.1*Math.PI,.9*Math.PI,!1),t.lineWidth=Math.max(Math.ceil(r/15),1),t.strokeStyle="black",t.stroke(),t.beginPath(),t.arc(e-.3*r,i-.25*r,Math.max(Math.ceil(r/15),1),0,2*Math.PI,!1),t.fillStyle="black",t.fill(),t.arc(e+.3*r,i-.25*r,Math.max(Math.ceil(r/15),1),0,2*Math.PI,!1),t.fill()},update:function(t){this.lastX=this.x,this.lastY=this.y,this.isBeingDragged&&window.Mouse?(this.x=Mouse.coords.x+world.xOffset-this.width/2,this.y=Mouse.coords.y+world.yOffset-this.height/2):(this.processInput(t),this.ambientAcceleration(),this.move(),App.Utils.almostEqual(this.lastX,this.x,1e-6)&&(this.fallLeft=null),!this.GRAVITY||this.y+this.height==world.height&&this.STAY_IN_WORLD||this.startFalling()),this.updateAnimation(),this.dampVelocity()},processInput:function(t){var e=!1,i=!1,s=!1,n=App.Utils.anyIn,a=this.keys||window.keys;if(void 0!==a){if(t===void 0||0===t.length){if(!this.CONTINUOUS_MOVEMENT)return;t=this.lastLooked}if(this.lastDirection=t.slice(),n(a.left,t)?(e=!0,s=!0,this.fallLeft=!0,this.GRAVITY&&this.isInAir()?(this.jumpDirection.right||!this.jumpDirection.left)&&(this.xVelocity=-this.MOVEAMOUNT*this.AIR_CONTROL,this.jumpDirection.right=!1,this.jumpDirection.left=!1):this.xVelocity=-this.MOVEAMOUNT):n(a.right,t)&&(i=!0,s=!0,this.fallLeft=!1,this.GRAVITY&&this.isInAir()?(this.jumpDirection.left||!this.jumpDirection.right)&&(this.xVelocity=this.MOVEAMOUNT*this.AIR_CONTROL,this.jumpDirection.right=!1,this.jumpDirection.left=!1):this.xVelocity=this.MOVEAMOUNT),n(a.up,t)){if(this.GRAVITY){if(!this.isInAir()||this.MULTI_JUMP>this.numJumps||-1==this.MULTI_JUMP){var o=App.physicsTimeElapsed;!(o-this.lastJump>this.JUMP_DELAY)||this.JUMP_RELEASE&&this.jumpKeyDown||(this.yVelocity=-this.JUMP_VEL,this.yAcceleration=0,this.lastJump=o,this.jumpDirection.right=i,this.jumpDirection.left=e,this.numJumps++,this.inAir=!0)}}else this.yVelocity=-this.MOVEAMOUNT,s=!0;this.jumpKeyDown=!0}else n(a.down,t)&&(this.isInAir()&&this.GRAVITY||(this.yVelocity=this.MOVEAMOUNT,s=!0));if(s&&(this.lastLooked=t.slice(),this.GRAVITY))for(var r=this.lastLooked.length-1;r>=0;r--)-1==a.left.indexOf(this.lastLooked[r])&&-1==a.right.indexOf(this.lastLooked[r])&&this.lastLooked.splice(r,1)}},ambientAcceleration:function(){this.GRAVITY&&(this.isInAir()?(this.yAcceleration+=this.G_CONST,this.jumpDirection.left?this.xVelocity=-this.MOVEAMOUNT:this.jumpDirection.right&&(this.xVelocity=this.MOVEAMOUNT)):this.stopFalling())},move:function(){var t=App.physicsDelta,e=t/2;this.xVelocity+=this.xAcceleration*e,this.yVelocity+=this.yAcceleration*e;var i=this.xVelocity,s=this.yVelocity;if(0!==i&&0!==s&&!this.GRAVITY){var n=Math.max(Math.abs(i),Math.abs(s)),a=Math.sqrt(i*i+s*s),o=n/a;this.xVelocity*=o,this.yVelocity*=o}this.x+=this.xVelocity*t,this.y+=this.yVelocity*t,this.xVelocity+=this.xAcceleration*e,this.yVelocity+=this.yAcceleration*e,this.stayInWorld()},stayInWorld:function(){this.STAY_IN_WORLD&&(0>this.x?this.x=0:this.x+this.width>world.width&&(this.x=world.width-this.width),0>this.y?this.y=0:this.y+this.height>world.height&&(this.y=world.height-this.height,this.stopFalling()))},dampVelocity:function(){return null===this.DAMPING_FACTOR||App.Utils.almostEqual(this.xVelocity,0,1e-4)?(this.xVelocity=0,this.GRAVITY||(this.yVelocity=0),void 0):(this.xVelocity*=1-this.DAMPING_FACTOR*App.physicsDelta,this.GRAVITY||App.Utils.almostEqual(this.yVelocity,0,1e-4)||(this.yVelocity*=1-this.DAMPING_FACTOR*App.physicsDelta),void 0)},addVelocityVector:function(t,e){this.xVelocity+=e*Math.cos(t),this.yVelocity+=e*Math.sin(t)},setVelocityVector:function(t,e){this.xVelocity=e*Math.cos(t),this.yVelocity=e*Math.sin(t)},getVelocityVector:function(){return{magnitude:Math.sqrt(this.xVelocity*this.xVelocity+this.yVelocity*this.yVelocity),direction:Math.atan2(this.yVelocity,this.xVelocity)}},addAccelerationVector:function(t,e){this.xAcceleration+=e*Math.cos(t),this.yAcceleration+=e*Math.sin(t)},setAccelerationVector:function(t,e){this.xAcceleration=e*Math.cos(t),this.yAcceleration=e*Math.sin(t)},getAccelerationVector:function(){return{magnitude:Math.sqrt(this.xVelocity*this.xVelocity+this.yVelocity*this.yVelocity),direction:Math.atan2(this.yVelocity,this.xVelocity)}},moveOutside:function(t){var e=Math.min(this.x+this.width-t.x,t.x+t.width-this.x),i=Math.min(this.y+this.height-t.y,t.y+t.height-this.y);return i>=e?{x:this.moveOutsideX(t),y:this.moveOutsideY(t)}:{y:this.moveOutsideY(t),x:this.moveOutsideX(t)}},moveOutsideX:function(t){var e=0,i;return this.overlaps(t)&&(i=this.x+this.width/2<t.x+t.width/2?t.x-this.width-.01:t.x+t.width+.01,e=i-this.x,this.x=i),e},moveOutsideY:function(t){var e=0,i;return this.overlaps(t)&&(i=this.y+this.height/2<=t.y+t.height/2?t.y-this.height-1:t.y+t.height+1,e=i-this.y,this.y=i),e},startFalling:function(){this.inAir||null===this.fallLeft||(this.jumpDirection.left=this.fallLeft,this.jumpDirection.right=!this.fallLeft),this.inAir=!0},stopFalling:function(){this.yAcceleration>0&&(this.yAcceleration=0),this.yVelocity>0&&(this.yVelocity=0),this.numJumps=0,this.inAir=!1},isInAir:function(){return this.inAir},isJumping:function(){return this.numJumps>0},isFalling:function(){return this.isInAir()&&0===this.numJumps},hasAirMomentum:function(){return null!==this.fallLeft||this.jumpDirection.left||this.jumpDirection.right},standingOn:function(t){if(Collection!==void 0&&t instanceof Collection||TileMap!==void 0&&t instanceof TileMap){for(var e=t.getAll(),i=0,s=e.length;s>i;i++)if(this.standingOn(e[i]))return!0;return!1}return this.overlapsX(t)&&App.Utils.almostEqual(this.y+this.height,t.y,1)},collideSolid:function(t){var e={x:0,y:0};if(t instanceof Box||t instanceof ImageWrapper)e=this._collideSolidBox(t);else if(Collection!==void 0&&t instanceof Collection||TileMap!==void 0&&t instanceof TileMap)for(var i=t.getAll(),s=0,n=i.length;n>s;s++){var a=this._collideSolidBox(i[s]);a.x&&(e.x=a.x),a.y&&(e.y=a.y)}return e.x=!!e.x,e.y=!!e.y,this.updateAnimation(e),e},_collideSolidBox:function(t){var e=!0,i={x:0,y:0};if(this.overlaps(t)&&(i=this.moveOutside(t)),this.GRAVITY){var s=this.x;this.x=this.lastX,this.standingOn(t)&&(this.stopFalling(),e=!1,"function"==typeof t.stoodOn&&t.stoodOn(this)),this.x=s,e&&(i.x||i.y)&&(App.Utils.almostEqual(this.y,t.y+t.height,1)?(0>this.yAcceleration&&(this.yAcceleration=0),0>this.yVelocity&&(this.yVelocity=0)):(this.jumpDirection.left=!1,this.jumpDirection.right=!1))}return i},updateAnimation:function(t){if(this.src instanceof SpriteMap){var e=this.keys||window.keys,i=this.lastDirection,s=App.Utils.anyIn,n=e!==void 0;n&&e.shoot!==void 0&&s(e.shoot,i)&&(i=this.lastLooked),this.isBeingDragged?this.useAnimation("drag","stand"):this.isInAir()?this.x>this.lastX?this.useAnimation("jumpRight","lookRight","stand"):this.x<this.lastX?this.useAnimation("jumpLeft","lookLeft","stand"):this.isJumping()?this.useAnimation("jump","stand"):this.useAnimation("fall","stand"):this.y>this.lastY?this.x>this.lastX?this.useAnimation("downRight","stand"):this.x<this.lastX?this.useAnimation("downLeft","stand"):this.useAnimation("down","stand"):this.y<this.lastY?this.x>this.lastX?this.useAnimation("upRight","stand"):this.x<this.lastX?this.useAnimation("upLeft","stand"):this.useAnimation("up","stand"):this.x>this.lastX?this.useAnimation("right","stand"):this.x<this.lastX?this.useAnimation("left","stand"):n&&s(e.up,i)?s(e.right,i)?this.useAnimation("lookUpRight","stand"):s(e.left,i)?this.useAnimation("lookUpLeft","stand"):this.useAnimation("lookUp","stand"):n&&s(e.down,i)?s(e.right,i)?this.useAnimation("lookDownRight","stand"):s(e.left,i)?this.useAnimation("lookDownLeft","stand"):this.useAnimation("lookDown","stand"):n&&s(e.right,i)?this.useAnimation(t&&t.x?"right":"lookRight","stand"):n&&s(e.left,i)?this.useAnimation(t&&t.x?"left":"lookLeft","stand"):this.useAnimation("stand")}},useAnimation:function(){if(void 0!==this.src.maps){for(var t=0;arguments.length>t;t++){var e=arguments[t];if(this.src.maps[e])return this.animLoop=e,e}return!1}},setDraggable:function(t){return this.isDraggable&&t?this:t?App.Events?window.Mouse?(this.isDraggable=!0,this.listen("mousedown.drag touchstart.drag",function(){App.isSomethingBeingDragged=!0,this.isBeingDragged=!0,this.dragStartX=this.x,this.dragStartY=this.y,jQuery(document).trigger("canvasdragstart",[this])}),this.listen("canvasdragstop.drag",function(){this.isBeingDragged=!1;var t=this.collides(this.dropTargets);this.dropTargets.length&&!t?(this.x=this.dragStartX,this.y=this.dragStartY):t&&jQuery(document).trigger("canvasdrop",[t])}),this):(window.console&&console.warn&&console.warn("Actor#setDraggable called, but window.Mouse does not exist."),this):(window.console&&console.warn&&console.warn("Actor#setDraggable called, but App.Events does not exist."),this):(this.isDraggable=!1,this.unlisten(".drag"),this)},getDraggable:function(){return this.isDraggable},release:function(t){var e=this.keys||window.keys;this.GRAVITY&&e!==void 0&&App.Utils.anyIn(e.up,t)&&(this.jumpKeyDown=!1)}}),Player=Actor.extend({MOVEWORLD:.45,JUMP_RELEASE:!0,init:function(){this._super.apply(this,arguments),arguments.length>0&&world.centerViewportAround(this.x,this.y);var t=this;this.__keytracker=function(){jQuery.hotkeys&&t.release([jQuery.hotkeys.lastKeyPressed()])},jQuery(document).on("keyup.release",this.__keytracker)},processInput:function(t){return t===void 0&&jQuery.hotkeys&&(t=jQuery.hotkeys.keysDown),this._super(t)},update:function(t){this._super(t),this.isBeingDragged||this.adjustViewport()},setDraggable:function(t){return t&&!this.isDraggable&&App.Events&&window.Mouse&&this.listen("canvasdragstop.drag",function(){!this.isBeingDragged||this.dropTargets.length&&!this.collides(this.dropTargets)||world.centerViewportAround(this.x,this.y)},-1),this._super.apply(this,arguments)},adjustViewport:function(){var t=world.getOffsets(),e={x:0,y:0};return window.Mouse&&Mouse.Scroll.isEnabled()?e:(t.x>0&&this.x+this.width/2-t.x<canvas.width*this.MOVEWORLD?(world.xOffset=Math.max(t.x+(this.x-this.lastX),0),context.translate(t.x-world.xOffset,0),e.x=t.x-world.xOffset):t.x<world.width-canvas.width&&this.x+this.width/2-t.x>canvas.width*(1-this.MOVEWORLD)&&(world.xOffset=Math.min(t.x+(this.x-this.lastX),world.width-canvas.width),context.translate(t.x-world.xOffset,0),e.x=t.x-world.xOffset),t.y>0&&this.y+this.height/2-t.y<canvas.height*this.MOVEWORLD?(world.yOffset=Math.max(t.y+(this.y-this.lastY),0),context.translate(0,t.y-world.yOffset),e.y=t.y-world.yOffset):t.y<world.height-canvas.height&&this.y+this.height/2-t.y>canvas.height*(1-this.MOVEWORLD)&&(world.yOffset=Math.min(t.y+(this.y-this.lastY),world.height-canvas.height),context.translate(0,t.y-world.yOffset),e.y=t.y-world.yOffset),e)},destroy:function(){this._super.apply(this,arguments),jQuery(document).off(".release",this.__keytracker)}});
/*
//@ sourceMappingURL=combined.min.map
*/